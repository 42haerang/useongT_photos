<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>느좋 송우성T 화보집</title>

  <!-- 첫 사진만 선로딩 -->
  <link rel="preload" as="image" href="01.jpg" imagesrcset="01.avif 1x, 01.webp 1x, 01.jpg 1x">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:#0f0f10;color:#e9ecef;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Arial,sans-serif;
      overflow:hidden;
      overscroll-behavior:none;
    }

    /* ===== 배경 (타이머 삭제, 스냅 시만 변경) ===== */
    .bgwrap{position:fixed;inset:0;z-index:-1;}
    .bgwrap .bg{
      position:absolute;inset:0;
      background-size:cover;background-position:center;
      opacity:0;transition:opacity 800ms ease;
      filter:brightness(.9) contrast(1.03) saturate(1.02);
    }
    .bgwrap .bg.show{opacity:.9}

    header{
      position:fixed;top:0;left:0;right:0;
      padding:18px 16px 10px;
      background:rgba(15,15,16,.7);backdrop-filter:blur(8px);
      border-bottom:1px solid #26282c;z-index:10;
    }
    header h1{margin:0;font-size:20px}

    /* ===== 앨범 (가로 슬라이드) ===== */
    .album{
      display:flex;
      height:100vh;
      transition:transform .55s cubic-bezier(.22,.61,.36,1);
      touch-action:pan-y;
      will-change: transform;
    }
    .dragging .album{transition:none;}
    .card{
      flex:0 0 100vw;height:100vh;display:flex;align-items:center;justify-content:center;position:relative;
      /* 오프스크린 렌더링 건너뛰기 → 초기 페인트/JS 부담↓ */
      content-visibility:auto;
      contain-intrinsic-size: 100vh 100vw;
    }

    /* ===== 표지 (야경) ===== */
    .card.cover{overflow:hidden;}
    .card.cover .coverBg{
      position:absolute;inset:0;
      background-image:url('fbg.jpg');
      background-size:cover;background-position:center;
      filter:blur(2px) brightness(.95) contrast(1.08) saturate(1.15);
      transform:scale(1.03);
    }
    .card.cover .coverShade::before,
    .card.cover .coverShade::after{
      content:"";position:absolute;inset:0;pointer-events:none;
    }
    .card.cover .coverShade::before{
      background:linear-gradient(180deg, rgba(0,0,0,.45) 0%, rgba(0,0,0,.35) 50%, rgba(255,220,140,.18) 100%);
      mix-blend-mode:overlay;
    }
    .card.cover .coverShade::after{
      background:radial-gradient(60% 25% at 50% 95%, rgba(255,220,120,.3), transparent 70%);
      mix-blend-mode:screen;
    }
    .card.cover .coverInner{
      position:absolute;bottom:8vh;left:50%;transform:translateX(-50%);
      z-index:1;text-align:center;width:100%;
    }
    .card.cover h2{
      font-size:clamp(28px,7vw,54px);font-weight:700;color:#f7f8ff;
      text-shadow:0 2px 12px rgba(0,0,0,.6), 0 0 24px rgba(160,180,255,.25);
    }

    /* ===== 카드 (기울어진 사진 유지) ===== */
    .cardBox{
      position:relative;width:100%;height:100%;
      background-image:var(--bgimg);
      background-size:cover;background-position:center;
      filter:brightness(1) contrast(1.05) saturate(1.08);
    }
    .cardBox .bgTint{
      position:absolute;inset:0;pointer-events:none;
      background:
        linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.25)),
        radial-gradient(50% 40% at 50% 40%, rgba(0,0,0,.15), transparent 60%);
    }
    .photoWrap{
      position:absolute;left:50%;top:50%;
      width:min(calc(var(--size,1)*80%), calc(var(--size,1)*420px));
      transform:translate(-50%,-50%) rotate(var(--rot));
    }
    .photoWrap img{
      width:100%;height:auto;display:block;border-radius:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.35);
      user-select:none;-webkit-user-drag:none;background:#0b0b0c;
    }
    .photoWrap .frame{
      position:absolute;inset:-6px;border:2px solid rgba(255,255,255,.85);
      border-radius:16px;pointer-events:none;
    }

    @media (prefers-reduced-motion: reduce){
      .album, .bgwrap .bg { transition:none; }
    }
  </style>
</head>
<body>
  <div class="bgwrap">
    <div class="bg" id="bg1"></div>
    <div class="bg" id="bg2"></div>
  </div>

  <header><h1>느좋 송우성T 화보집</h1></header>

  <main class="stage">
    <div class="album" id="album"></div>
  </main>

  <script>
    /* ===== 이미지 세팅 ===== */
    const images = [
      {src:'01.jpg', size:0.85},
      {src:'02.jpg', size:0.90},
      {src:'03.jpg', size:0.78},
      {src:'04.jpg', size:0.80},
      {src:'05.jpg', size:0.82},
      {src:'06.jpg', size:0.88},
      {src:'07.jpg', size:0.83},
      {src:'08.jpg', size:0.92}
    ];
    const backgrounds = [...Array(8)].map((_,i)=>`bg${i+1}.jpg`);

    /* ===== 표지 + 카드 생성 (이미지 지연 로딩) ===== */
    const album = document.getElementById('album');

    const cover = `
      <article class="card cover" data-kind="cover">
        <div class="coverBg" aria-hidden="true"></div>
        <div class="coverShade" aria-hidden="true"></div>
        <div class="coverInner">
          <h2>느좋 송우성T 화보집</h2>
        </div>
      </article>`;

    const cards = images.map((it,idx)=>{
      const rot=(idx%2===0?'-':'')+'17deg';
      const bgurl=backgrounds[idx%backgrounds.length];
      // 최초 로딩 부담↓: data-src 로 지연세팅, 첫 장만 즉시 로드
      const isFirst = idx===0;
      const imgAttrs = isFirst
        ? `src="${it.src}" fetchpriority="high" decoding="async"`
        : `data-src="${it.src}" loading="lazy" decoding="async" fetchpriority="low"`;
      return `
        <article class="card" data-kind="photo" data-idx="${idx}">
          <div class="cardBox" style="--bgimg:url('${bgurl}')">
            <span class="bgTint" aria-hidden="true"></span>
            <div class="photoWrap" style="--rot:${rot}; --size:${it.size}">
              <img ${imgAttrs} alt="photo${idx+1}">
              <span class="frame"></span>
            </div>
          </div>
        </article>`;
    }).join('');

    album.innerHTML = cover + cards;

    /* ===== 배경: 슬라이드 이동 시에만 교체 ===== */
    const bgA = document.getElementById('bg1');
    const bgB = document.getElementById('bg2');
    let bgShowing = 0;

    function setBgByIndex(i){
      const pick = backgrounds[i % backgrounds.length] || backgrounds[0];
      const front = bgShowing ? bgA : bgB;
      const back  = bgShowing ? bgB : bgA;
      back.style.backgroundImage = `url(${pick})`;
      back.classList.add('show');
      front.classList.remove('show');
      bgShowing ^= 1;
    }

    /* ===== 가로 드래그 슬라이드 (smoother) ===== */
    let index = 0;
    const total = images.length + 1;
    const albumEl = album;

    const snap = () => {
      albumEl.style.transform = `translate3d(-${index * 100}vw, 0, 0)`;
      // 현재 인덱스 기준 배경/이미지 프리로드
      setBgByIndex(Math.max(0, index-1)); // 표지일 때도 안전
      preloadSlide(index);
      preloadSlide(index+1);
      preloadSlide(index-1);
    };
    // 초기 상태
    setBgByIndex(0);
    snap();

    // 지연 로딩: 해당 슬라이드의 <img>가 data-src면 실제 src로 교체
    function preloadSlide(i){
      const card = albumEl.children[i];
      if(!card) return;
      const img = card.querySelector('img[data-src]');
      if(img){
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
      }
    }

    let dragging = false;
    let startX = 0, curX = 0, lastX = 0;
    let startT = 0, lastT = 0;

    const thresholdPx = () => Math.min(80, window.innerWidth * 0.18);

    const onStart = (x) => {
      dragging = true;
      startX = curX = lastX = x;
      startT = lastT = performance.now();
      document.body.classList.add('dragging');
    };

    const onMove = (x) => {
      if (!dragging) return;
      curX = x;
      const dx = curX - startX;
      albumEl.style.transform = `translate3d(calc(-${index * 100}vw + ${dx}px), 0, 0)`;
      lastX = curX;
      lastT = performance.now();
    };

    const onEnd = () => {
      if (!dragging) return;
      dragging = false;
      document.body.classList.remove('dragging');

      const dxTotal = lastX - startX;
      const dt = Math.max(1, lastT - startT);
      const velocity = dxTotal / dt; // px/ms

      const fast = Math.abs(velocity) > 0.6;
      const far  = Math.abs(dxTotal) > thresholdPx();

      if ((dxTotal < 0 && (far || fast)) && index < total - 1) index++;
      else if ((dxTotal > 0 && (far || fast)) && index > 0)    index--;

      snap();
    };

    /* 터치 */
    albumEl.addEventListener('touchstart', e => onStart(e.touches[0].clientX), {passive:true});
    albumEl.addEventListener('touchmove',  e => onMove(e.touches[0].clientX),  {passive:true});
    albumEl.addEventListener('touchend',   onEnd);

    /* 마우스 */
    albumEl.addEventListener('mousedown', e => onStart(e.clientX));
    window.addEventListener('mousemove',  e => onMove(e.clientX));
    window.addEventListener('mouseup',    onEnd);

    /* 키보드(옵션) */
    window.addEventListener('keydown', e=>{
      if(e.key==='ArrowRight' && index<total-1){ index++; snap(); }
      if(e.key==='ArrowLeft'  && index>0){      index--; snap(); }
    });

    /* 유휴 시간에 추가 프리로드(브라우저 지원 시) */
    (window.requestIdleCallback || function(fn){setTimeout(fn,500)})(()=>{
      preloadSlide(2);
      preloadSlide(3);
    });
  </script>
</body>
</html>
